{
  "paragraphs": [
    {
      "text": "%md\n\n\u003e :bulb: This example will show how to efficiently aggregate time series data on two different levels of granularity.\n\nThe source table (`server_logs`) is backed by the [`faker` connector](https://flink-packages.org/packages/flink-faker), which continuously generates rows in memory based on Java Faker expressions.\n\nBased on our `server_logs` table we would like to compute the average request size over one minute **as well as five minute (event) windows.** \nFor this, you could run two queries, similar to the one in [Aggregating Time Series Data](../01_group_by_window/01_group_by_window.md). \nAt the end of the page is the script and resulting JobGraph from this approach. \n\nIn the main part, we will follow a slightly more efficient approach that chains the two aggregations: the one-minute aggregation output serves as the five-minute aggregation input.\n\nWe then use a [Statements Set](../../foundations/08_statement_sets/08_statement_sets.md) to write out the two result tables. \nTo keep this example self-contained, we use two tables of type `blackhole` instead of `kafka`, `filesystem`, or any other [connectors](https://ci.apache.org/projects/flink/flink-docs-stable/docs/connectors/table/overview/). ",
      "user": "anonymous",
      "dateUpdated": "2021-10-08 16:30:31.850",
      "progress": 0,
      "config": {
        "tableHide": false,
        "editorSetting": {
          "language": "markdown",
          "editOnDblClick": true,
          "completionKey": "TAB",
          "completionSupport": false
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/markdown",
        "fontSize": 9.0,
        "editorHide": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "HTML",
            "data": "\u003cdiv class\u003d\"markdown-body\"\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ This example will show how to efficiently aggregate time series data on two different levels of granularity.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThe source table (\u003ccode\u003eserver_logs\u003c/code\u003e) is backed by the \u003ca href\u003d\"https://flink-packages.org/packages/flink-faker\"\u003e\u003ccode\u003efaker\u003c/code\u003e connector\u003c/a\u003e, which continuously generates rows in memory based on Java Faker expressions.\u003c/p\u003e\n\u003cp\u003eBased on our \u003ccode\u003eserver_logs\u003c/code\u003e table we would like to compute the average request size over one minute \u003cstrong\u003eas well as five minute (event) windows.\u003c/strong\u003e\u003cbr /\u003e\nFor this, you could run two queries, similar to the one in \u003ca href\u003d\"../01_group_by_window/01_group_by_window.md\"\u003eAggregating Time Series Data\u003c/a\u003e.\u003cbr /\u003e\nAt the end of the page is the script and resulting JobGraph from this approach.\u003c/p\u003e\n\u003cp\u003eIn the main part, we will follow a slightly more efficient approach that chains the two aggregations: the one-minute aggregation output serves as the five-minute aggregation input.\u003c/p\u003e\n\u003cp\u003eWe then use a \u003ca href\u003d\"../../foundations/08_statement_sets/08_statement_sets.md\"\u003eStatements Set\u003c/a\u003e to write out the two result tables.\u003cbr /\u003e\nTo keep this example self-contained, we use two tables of type \u003ccode\u003eblackhole\u003c/code\u003e instead of \u003ccode\u003ekafka\u003c/code\u003e, \u003ccode\u003efilesystem\u003c/code\u003e, or any other \u003ca href\u003d\"https://ci.apache.org/projects/flink/flink-docs-stable/docs/connectors/table/overview/\"\u003econnectors\u003c/a\u003e.\u003c/p\u003e\n\n\u003c/div\u003e"
          }
        ]
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614313809667_126135129",
      "id": "paragraph_1614313809667_126135129",
      "dateCreated": "2021-02-26 12:30:09.667",
      "dateStarted": "2021-10-08 16:30:31.852",
      "dateFinished": "2021-10-08 16:30:31.860",
      "status": "FINISHED"
    },
    {
      "text": "%md\n\næœ¬ä¾‹å°†å±•ç¤ºå¦‚ä½•åœ¨2ä¸ªä¸åŒçš„ç²’åº¦ç­‰çº§ä¸Šé«˜æ ¡çš„èšåˆæ—¶é—´åºåˆ—æ•°æ®ã€‚\n\nä¾‹å­ä¸­ä½¿ç”¨çš„ source è¡¨`server_logs` çš„æ•°æ®æ˜¯åˆ©ç”¨  [`faker` connector](https://github.com/knaufk/flink-faker) äº§ç”Ÿçš„ï¼Œå®ƒåŸºäº Java Faker è¡¨è¾¾å¼ä¸æ–­çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆæ•°æ®\n\nåŸºäºæˆ‘ä»¬çš„ `server_logs è¡¨æˆ‘ä»¬å¯èƒ½å¸Œæœ›è®¡ç®—æ¯åˆ†é’Ÿ**ä»¥åŠæ¯5åˆ†é’Ÿ**çš„å¹³å‡è¯·æ±‚å¤§å°, ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ 2 æ¡ä¸ Aggregating Time Series Data ä¾‹å­ä¸­ç±»ä¼¼æŸ¥è¯¢è¯­å¥ã€‚è¿™ç§æ–¹å¼çš„æ…åˆå’Œç»“æœ JobGraph åœ¨é¡µé¢çš„æœ«å°¾ã€‚\n\nå¯¹å…¶ä¸­ä¸»è¦çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç¨å¾®é«˜æ•ˆçš„æ–¹å¼å³å°† 2 ä¸ªèšåˆé“¾æ¥èµ·æ¥ï¼šå°†ä¸€åˆ†é’Ÿçš„èšåˆè¾“å‡ºä½œä¸º 5 åˆ†é’Ÿçš„èšåˆè¾“å…¥ã€‚\n\næ¥ç€æˆ‘ä»¬ä½¿ç”¨ `runAsOne` å‘ 2 å¼ ç»“æœè¡¨å†™å…¥æ•°æ®ã€‚ä¸ºäº†è®©è¿™ä¸ªä¾‹å­ä¸ä¾èµ–ä»»ä½•ä¾èµ–ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ 2 ä¸ª `blackhole` ç±»å‹çš„è¡¨ï¼Œè€Œä¸ç”¨  `kafka`, `filesystem` ç­‰å…¶ä»–[connectors](https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/)ã€‚\n",
      "user": "anonymous",
      "dateUpdated": "2021-03-18 15:55:06.388",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "markdown",
          "editOnDblClick": true,
          "completionKey": "TAB",
          "completionSupport": false
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/markdown",
        "fontSize": 9.0,
        "results": {},
        "enabled": true,
        "editorHide": true,
        "tableHide": false
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "HTML",
            "data": "\u003cdiv class\u003d\"markdown-body\"\u003e\n\u003cp\u003eæœ¬ä¾‹å°†å±•ç¤ºå¦‚ä½•åœ¨2ä¸ªä¸åŒçš„ç²’åº¦ç­‰çº§ä¸Šé«˜æ ¡çš„èšåˆæ—¶é—´åºåˆ—æ•°æ®ã€‚\u003c/p\u003e\n\u003cp\u003eä¾‹å­ä¸­ä½¿ç”¨çš„ source è¡¨\u003ccode\u003eserver_logs\u003c/code\u003e çš„æ•°æ®æ˜¯åˆ©ç”¨  \u003ca href\u003d\"https://github.com/knaufk/flink-faker\"\u003e\u003ccode\u003efaker\u003c/code\u003e connector\u003c/a\u003e äº§ç”Ÿçš„ï¼Œå®ƒåŸºäº Java Faker è¡¨è¾¾å¼ä¸æ–­çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆæ•°æ®\u003c/p\u003e\n\u003cp\u003eåŸºäºæˆ‘ä»¬çš„ `server_logs è¡¨æˆ‘ä»¬å¯èƒ½å¸Œæœ›è®¡ç®—æ¯åˆ†é’Ÿ\u003cstrong\u003eä»¥åŠæ¯5åˆ†é’Ÿ\u003c/strong\u003eçš„å¹³å‡è¯·æ±‚å¤§å°, ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ 2 æ¡ä¸ Aggregating Time Series Data ä¾‹å­ä¸­ç±»ä¼¼æŸ¥è¯¢è¯­å¥ã€‚è¿™ç§æ–¹å¼çš„æ…åˆå’Œç»“æœ JobGraph åœ¨é¡µé¢çš„æœ«å°¾ã€‚\u003c/p\u003e\n\u003cp\u003eå¯¹å…¶ä¸­ä¸»è¦çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç¨å¾®é«˜æ•ˆçš„æ–¹å¼å³å°† 2 ä¸ªèšåˆé“¾æ¥èµ·æ¥ï¼šå°†ä¸€åˆ†é’Ÿçš„èšåˆè¾“å‡ºä½œä¸º 5 åˆ†é’Ÿçš„èšåˆè¾“å…¥ã€‚\u003c/p\u003e\n\u003cp\u003eæ¥ç€æˆ‘ä»¬ä½¿ç”¨ \u003ccode\u003erunAsOne\u003c/code\u003e å‘ 2 å¼ ç»“æœè¡¨å†™å…¥æ•°æ®ã€‚ä¸ºäº†è®©è¿™ä¸ªä¾‹å­ä¸ä¾èµ–ä»»ä½•ä¾èµ–ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ 2 ä¸ª \u003ccode\u003eblackhole\u003c/code\u003e ç±»å‹çš„è¡¨ï¼Œè€Œä¸ç”¨  \u003ccode\u003ekafka\u003c/code\u003e, \u003ccode\u003efilesystem\u003c/code\u003e ç­‰å…¶ä»–\u003ca href\u003d\"https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/\"\u003econnectors\u003c/a\u003eã€‚\u003c/p\u003e\n\n\u003c/div\u003e"
          }
        ]
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1615118584595_491576797",
      "id": "paragraph_1615118584595_491576797",
      "dateCreated": "2021-03-07 12:03:04.595",
      "dateStarted": "2021-03-18 15:55:06.394",
      "dateFinished": "2021-03-18 15:55:06.412",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql\n\nDROP TABLE IF EXISTS server_logs;\n\nCREATE TABLE server_logs ( \n    log_time TIMESTAMP(3),\n    client_ip STRING,\n    client_identity STRING, \n    userid STRING, \n    request_line STRING, \n    status_code STRING, \n    size INT, \n    WATERMARK FOR log_time AS log_time - INTERVAL \u002715\u0027 SECONDS\n) WITH (\n  \u0027connector\u0027 \u003d \u0027faker\u0027, \n  \u0027fields.client_ip.expression\u0027 \u003d \u0027#{Internet.publicIpV4Address}\u0027,\n  \u0027fields.client_identity.expression\u0027 \u003d  \u0027-\u0027,\n  \u0027fields.userid.expression\u0027 \u003d  \u0027#{regexify \u0027\u0027(morsapaes|knauf|sjwiesman){1}\u0027\u0027}\u0027,\n  \u0027fields.log_time.expression\u0027 \u003d  \u0027#{date.past \u0027\u002715\u0027\u0027,\u0027\u00275\u0027\u0027,\u0027\u0027SECONDS\u0027\u0027}\u0027,\n  \u0027fields.request_line.expression\u0027 \u003d \u0027#{regexify \u0027\u0027(GET|POST|PUT|PATCH){1}\u0027\u0027} #{regexify \u0027\u0027(/search\\.html|/login\\.html|/prod\\.html|cart\\.html|/order\\.html){1}\u0027\u0027} #{regexify \u0027\u0027(HTTP/1\\.1|HTTP/2|/HTTP/1\\.0){1}\u0027\u0027}\u0027,\n  \u0027fields.status_code.expression\u0027 \u003d \u0027#{regexify \u0027\u0027(200|201|204|400|401|403|301){1}\u0027\u0027}\u0027,\n  \u0027fields.size.expression\u0027 \u003d \u0027#{number.numberBetween \u0027\u0027100\u0027\u0027,\u0027\u002710000000\u0027\u0027}\u0027\n);\n\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 12:31:10.680",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304339896_1045253871",
      "id": "paragraph_1614304339896_1045253871",
      "dateCreated": "2021-02-26 09:52:19.896",
      "dateStarted": "2021-02-26 12:31:10.712",
      "dateFinished": "2021-02-26 12:31:11.499",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql\n\n\nDROP TABLE IF EXISTS avg_request_size_1m;\n\nCREATE TABLE avg_request_size_1m (\n  window_start TIMESTAMP(3),\n  window_end TIMESTAMP(3),\n  avg_size BIGINT\n)\nWITH (\n  \u0027connector\u0027 \u003d \u0027blackhole\u0027\n);\n\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 12:31:27.312",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304362241_1160995788",
      "id": "paragraph_1614304362241_1160995788",
      "dateCreated": "2021-02-26 09:52:42.241",
      "dateStarted": "2021-02-26 12:31:27.321",
      "dateFinished": "2021-02-26 12:31:28.185",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql\n\nDROP TABLE IF EXISTS avg_request_size_5m;\n\nCREATE TABLE avg_request_size_5m (\n  window_start TIMESTAMP(3),\n  window_end TIMESTAMP(3),\n  avg_size BIGINT\n)\nWITH (\n  \u0027connector\u0027 \u003d \u0027blackhole\u0027\n);\n\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 12:31:29.268",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304382217_422996202",
      "id": "paragraph_1614304382217_422996202",
      "dateCreated": "2021-02-26 09:53:02.217",
      "dateStarted": "2021-02-26 12:31:29.274",
      "dateFinished": "2021-02-26 12:31:30.037",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql\n\nDROP VIEW IF EXISTS server_logs_window_1m;\n\nCREATE VIEW server_logs_window_1m AS \nSELECT  \n  TUMBLE_START(log_time, INTERVAL \u00271\u0027 MINUTE) AS window_start,\n  TUMBLE_ROWTIME(log_time, INTERVAL \u00271\u0027 MINUTE) AS window_end,\n  SUM(size) AS total_size,\n  COUNT(*) AS num_requests\nFROM server_logs\nGROUP BY \n  TUMBLE(log_time, INTERVAL \u00271\u0027 MINUTE);\n\n\nDROP VIEW IF EXISTS server_logs_window_5m;\n\nCREATE VIEW server_logs_window_5m AS \nSELECT \n  TUMBLE_START(window_end, INTERVAL \u00275\u0027 MINUTE) AS window_start,\n  TUMBLE_ROWTIME(window_end, INTERVAL \u00275\u0027 MINUTE) AS window_end,\n  SUM(total_size) AS total_size,\n  SUM(num_requests) AS num_requests\nFROM server_logs_window_1m\nGROUP BY \n  TUMBLE(window_end, INTERVAL \u00275\u0027 MINUTE);\n  ",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 12:31:37.435",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304436053_2145075386",
      "id": "paragraph_1614304436053_2145075386",
      "dateCreated": "2021-02-26 09:53:56.053",
      "dateStarted": "2021-02-26 12:31:33.468",
      "dateFinished": "2021-02-26 12:31:34.302",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql(runAsOne\u003dtrue)\n\nINSERT INTO avg_request_size_1m SELECT\n  window_start,\n  window_end, \n  total_size/num_requests AS avg_size\nFROM server_logs_window_1m;\n\nINSERT INTO avg_request_size_5m SELECT\n  window_start,\n  window_end, \n  total_size/num_requests AS avg_size\nFROM server_logs_window_5m;\n\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 12:31:41.628",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {
        "jobUrl": {
          "propertyName": "jobUrl",
          "label": "FLINK JOB",
          "tooltip": "View in Flink web UI",
          "group": "flink",
          "values": [
            {
              "jobUrl": "http://localhost:8081#/job/c34cc9fab06d3a9be8ad7646c1c60161"
            }
          ],
          "interpreterSettingId": "flink"
        }
      },
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304458895_529580474",
      "id": "paragraph_1614304458895_529580474",
      "dateCreated": "2021-02-26 09:54:18.895",
      "dateStarted": "2021-02-26 12:31:41.644",
      "dateFinished": "2021-02-26 09:58:50.244",
      "status": "ABORT"
    },
    {
      "text": "%flink.ssql\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 09:57:03.613",
      "progress": 0,
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614304623613_747935414",
      "id": "paragraph_1614304623613_747935414",
      "dateCreated": "2021-02-26 09:57:03.613",
      "status": "READY"
    }
  ],
  "name": "07 Chained (Event) Time Windows",
  "id": "2FZ88A3H2",
  "defaultInterpreterGroup": "flink",
  "version": "0.10.0-SNAPSHOT",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {
    "flink-shared_process": [
      {
        "name": "duration",
        "object": "1 hours 3 minutes 47 seconds",
        "noteId": "2FZ88A3H2",
        "paragraphId": "paragraph_1614304458895_529580474"
      }
    ]
  },
  "config": {
    "isZeppelinNotebookCronEnable": false
  },
  "info": {}
}