{
  "paragraphs": [
    {
      "text": "%md\n\n\u003e :bulb: This example will show how you can enrich a stream with an external table of reference data (i.e. a _lookup_ table).\n\n## Data Enrichment\n\nNot all data changes frequently, even when working in real-time: in some cases, you might need to enrich streaming data with static â€” or _reference_ â€” data that is stored externally. For example, `user` metadata may be stored in a relational database that Flink needs to join against directly.\nFlink SQL allows you to look up reference data and join it with a stream using a _lookup join_. The join requires one table to have a [processing time attribute](https://docs.ververica.com/user_guide/sql_development/table_view.html#processing-time-attributes) and the other table to be backed by a [lookup source connector](https://docs.ververica.com/user_guide/sql_development/connectors.html#id1), like the JDBC connector.\n\n## Using Lookup Joins\n\nIn this example, you will look up reference user data stored in MySQL to flag subscription events for users that are minors (`age \u003c 18`). The `FOR SYSTEM_TIME AS OF` clause uses the processing time attribute to ensure that each row of the `subscriptions` table is joined with the `users` rows that match the join predicate at the point in time when the `subscriptions` row is processed by the join operator. The lookup join also requires an equality join predicate based on the `PRIMARY KEY` of the lookup table (`usub.user_id \u003d u.user_id`). Here, the source does not have to read the entire table and can lazily fetch individual values from the external table when necessary.\n\n## Script\n\nThe source table (`subscriptions`) is backed by the [`faker` connector](https://github.com/knaufk/flink-faker), which continuously generates rows in memory based on Java Faker expressions. The `users` table is backed by an existing MySQL reference table using the [JDBC connector](https://ci.apache.org/projects/flink/flink-docs-stable/dev/table/connectors/jdbc.html).\n",
      "user": "anonymous",
      "dateUpdated": "2021-10-08 22:58:34.507",
      "progress": 0,
      "config": {
        "tableHide": false,
        "editorSetting": {
          "language": "markdown",
          "editOnDblClick": true,
          "completionKey": "TAB",
          "completionSupport": false
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/markdown",
        "fontSize": 9.0,
        "editorHide": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "HTML",
            "data": "\u003cdiv class\u003d\"markdown-body\"\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ This example will show how you can enrich a stream with an external table of reference data (i.e. a \u003cem\u003elookup\u003c/em\u003e table).\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eData Enrichment\u003c/h2\u003e\n\u003cp\u003eNot all data changes frequently, even when working in real-time: in some cases, you might need to enrich streaming data with static â€” or \u003cem\u003ereference\u003c/em\u003e â€” data that is stored externally. For example, \u003ccode\u003euser\u003c/code\u003e metadata may be stored in a relational database that Flink needs to join against directly.\u003cbr /\u003e\nFlink SQL allows you to look up reference data and join it with a stream using a \u003cem\u003elookup join\u003c/em\u003e. The join requires one table to have a \u003ca href\u003d\"https://docs.ververica.com/user_guide/sql_development/table_view.html#processing-time-attributes\"\u003eprocessing time attribute\u003c/a\u003e and the other table to be backed by a \u003ca href\u003d\"https://docs.ververica.com/user_guide/sql_development/connectors.html#id1\"\u003elookup source connector\u003c/a\u003e, like the JDBC connector.\u003c/p\u003e\n\u003ch2\u003eUsing Lookup Joins\u003c/h2\u003e\n\u003cp\u003eIn this example, you will look up reference user data stored in MySQL to flag subscription events for users that are minors (\u003ccode\u003eage \u0026lt; 18\u003c/code\u003e). The \u003ccode\u003eFOR SYSTEM_TIME AS OF\u003c/code\u003e clause uses the processing time attribute to ensure that each row of the \u003ccode\u003esubscriptions\u003c/code\u003e table is joined with the \u003ccode\u003eusers\u003c/code\u003e rows that match the join predicate at the point in time when the \u003ccode\u003esubscriptions\u003c/code\u003e row is processed by the join operator. The lookup join also requires an equality join predicate based on the \u003ccode\u003ePRIMARY KEY\u003c/code\u003e of the lookup table (\u003ccode\u003eusub.user_id \u003d u.user_id\u003c/code\u003e). Here, the source does not have to read the entire table and can lazily fetch individual values from the external table when necessary.\u003c/p\u003e\n\u003ch2\u003eScript\u003c/h2\u003e\n\u003cp\u003eThe source table (\u003ccode\u003esubscriptions\u003c/code\u003e) is backed by the \u003ca href\u003d\"https://github.com/knaufk/flink-faker\"\u003e\u003ccode\u003efaker\u003c/code\u003e connector\u003c/a\u003e, which continuously generates rows in memory based on Java Faker expressions. The \u003ccode\u003eusers\u003c/code\u003e table is backed by an existing MySQL reference table using the \u003ca href\u003d\"https://ci.apache.org/projects/flink/flink-docs-stable/dev/table/connectors/jdbc.html\"\u003eJDBC connector\u003c/a\u003e.\u003c/p\u003e\n\n\u003c/div\u003e"
          }
        ]
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614316800709_621606447",
      "id": "paragraph_1614316800709_621606447",
      "dateCreated": "2021-02-26 13:20:00.710",
      "dateStarted": "2021-10-08 22:58:34.509",
      "dateFinished": "2021-10-08 22:58:34.515",
      "status": "FINISHED"
    },
    {
      "text": "%md\n\næœ¬æ–‡å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¤–éƒ¨è¡¨ä¸­çš„ reference æ•°æ®æ¥å……å®(enrich)ä¸€ä¸ªæµ(å³ _lookup_ è¡¨)ã€‚\n\n## æ•°æ®å……å®ï¼ˆdata enrichmentï¼‰\n\nå³ä½¿åœ¨å®æ—¶åœºæ™¯ä¸‹ï¼Œä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½é¢‘ç¹çš„æ”¹å˜ï¼šåœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨å‚¨å­˜åœ¨å¤–éƒ¨çš„é™æ€æˆ–è€…  _reference_ æ•°æ®æ¥æ‰©å±•ä¸€ä¸ªæµã€‚ä¾‹å¦‚ï¼Œ`user`è¡¨çš„å…ƒä¿¡æ¯å¯èƒ½å‚¨å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒFlink éœ€è¦ç›´æ¥ join è¿™ä¸ªè¡¨ã€‚\nFLINK SQL å…è®¸æˆ‘ä»¬æŸ¥è¯¢referenceæ•°æ®ï¼Œå¹¶ä½¿ç”¨ _lookup join_ æ¥å°†å®ƒä¸ä¸€ä¸ªæµ joinã€‚è¿™ä¸ª join æ“ä½œéœ€è¦ä¸€ä¸ªè¡¨æœ‰ [processing time attribute](https://docs.ververica.com/user_guide/sql_development/table_view.html#processing-time-attributes) å¦ä¸€ä¸ªè¡¨ä½¿ç”¨åƒ JDBC connector è¿™æ ·çš„ [lookup source connector](https://docs.ververica.com/user_guide/sql_development/connectors.html#id1) æ¥æä¾›æ•°æ®ã€‚\n\n## ä½¿ç”¨ Loopup Joins\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å‚¨å­˜åœ¨ MYSQL ä¸­çš„ç”¨æˆ· reference æ•°æ®æ¥æ ‡è®°æœªæˆå¹´ç”¨æˆ· (`age \u003c 18`).  `FOR SYSTEM_TIME AS OF` è¯­å¥ä½¿ç”¨å¤„ç†æ—¶é—´å±æ€§æ¥ç¡®ä¿ `subscriptions` è¡¨çš„æ¯ä¸€ä¸ªè¡Œåœ¨joinæ“ä½œå¤„ç†è¿™ä¸ª `subscriptions` è¡Œçš„æ—¶é—´ç‚¹ä¸  `users` è¡¨ä¸­  `users` è®°å½•è¿æ¥ã€‚lookup join ä¹Ÿéœ€è¦ä¸€ä¸ª åŸºäº lookup è¡¨ `PRIMARY KEY` çš„ ç›¸ç­‰ join è°“è¯ (`usub.user_id \u003d u.user_id`). è¿™é‡Œï¼Œæ•°æ®æºä¸éœ€è¦è¯»å–æ•´ä¸ªè¡¨ï¼Œå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ä»å¤–éƒ¨è¡¨ä¸­è·å–å„è‡ªéœ€è¦çš„å€¼ã€‚\n\n\n## è„šæœ¬\n\næ•°æ®æº `subscriptions` è¡¨ä½¿ç”¨ [`faker` connector](https://github.com/knaufk/flink-faker) æä¾›æ•°æ®ï¼Œå®ƒå¯ä»¥åŸºäº Java Faker è¡¨è¾¾å¼æŒç»­çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆæ•°æ®ã€‚`users` è¡¨ä½¿ç”¨  [JDBC connector](https://ci.apache.org/projects/flink/flink-docs-stable/dev/table/connectors/jdbc.html) ä»ä¸€ä¸ªå·²å­˜åœ¨çš„ MYSQL reference è¡¨ä¸­è·å–æ•°æ®ã€‚\n",
      "user": "anonymous",
      "dateUpdated": "2021-03-18 15:57:00.333",
      "progress": 0,
      "config": {
        "tableHide": false,
        "editorSetting": {
          "language": "markdown",
          "editOnDblClick": true,
          "completionKey": "TAB",
          "completionSupport": false
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/markdown",
        "fontSize": 9.0,
        "editorHide": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "HTML",
            "data": "\u003cdiv class\u003d\"markdown-body\"\u003e\n\u003cp\u003eæœ¬æ–‡å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¤–éƒ¨è¡¨ä¸­çš„ reference æ•°æ®æ¥å……å®(enrich)ä¸€ä¸ªæµ(å³ \u003cem\u003elookup\u003c/em\u003e è¡¨)ã€‚\u003c/p\u003e\n\u003ch2\u003eæ•°æ®å……å®ï¼ˆdata enrichmentï¼‰\u003c/h2\u003e\n\u003cp\u003eå³ä½¿åœ¨å®æ—¶åœºæ™¯ä¸‹ï¼Œä¹Ÿå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½é¢‘ç¹çš„æ”¹å˜ï¼šåœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨å‚¨å­˜åœ¨å¤–éƒ¨çš„é™æ€æˆ–è€…  \u003cem\u003ereference\u003c/em\u003e æ•°æ®æ¥æ‰©å±•ä¸€ä¸ªæµã€‚ä¾‹å¦‚ï¼Œ\u003ccode\u003euser\u003c/code\u003eè¡¨çš„å…ƒä¿¡æ¯å¯èƒ½å‚¨å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ŒFlink éœ€è¦ç›´æ¥ join è¿™ä¸ªè¡¨ã€‚\u003cbr /\u003e\nFLINK SQL å…è®¸æˆ‘ä»¬æŸ¥è¯¢referenceæ•°æ®ï¼Œå¹¶ä½¿ç”¨ \u003cem\u003elookup join\u003c/em\u003e æ¥å°†å®ƒä¸ä¸€ä¸ªæµ joinã€‚è¿™ä¸ª join æ“ä½œéœ€è¦ä¸€ä¸ªè¡¨æœ‰ \u003ca href\u003d\"https://docs.ververica.com/user_guide/sql_development/table_view.html#processing-time-attributes\"\u003eprocessing time attribute\u003c/a\u003e å¦ä¸€ä¸ªè¡¨ä½¿ç”¨åƒ JDBC connector è¿™æ ·çš„ \u003ca href\u003d\"https://docs.ververica.com/user_guide/sql_development/connectors.html#id1\"\u003elookup source connector\u003c/a\u003e æ¥æä¾›æ•°æ®ã€‚\u003c/p\u003e\n\u003ch2\u003eä½¿ç”¨ Loopup Joins\u003c/h2\u003e\n\u003cp\u003eåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å‚¨å­˜åœ¨ MYSQL ä¸­çš„ç”¨æˆ· reference æ•°æ®æ¥æ ‡è®°æœªæˆå¹´ç”¨æˆ· (\u003ccode\u003eage \u0026lt; 18\u003c/code\u003e).  \u003ccode\u003eFOR SYSTEM_TIME AS OF\u003c/code\u003e è¯­å¥ä½¿ç”¨å¤„ç†æ—¶é—´å±æ€§æ¥ç¡®ä¿ \u003ccode\u003esubscriptions\u003c/code\u003e è¡¨çš„æ¯ä¸€ä¸ªè¡Œåœ¨joinæ“ä½œå¤„ç†è¿™ä¸ª \u003ccode\u003esubscriptions\u003c/code\u003e è¡Œçš„æ—¶é—´ç‚¹ä¸  \u003ccode\u003eusers\u003c/code\u003e è¡¨ä¸­  \u003ccode\u003eusers\u003c/code\u003e è®°å½•è¿æ¥ã€‚lookup join ä¹Ÿéœ€è¦ä¸€ä¸ª åŸºäº lookup è¡¨ \u003ccode\u003ePRIMARY KEY\u003c/code\u003e çš„ ç›¸ç­‰ join è°“è¯ (\u003ccode\u003eusub.user_id \u003d u.user_id\u003c/code\u003e). è¿™é‡Œï¼Œæ•°æ®æºä¸éœ€è¦è¯»å–æ•´ä¸ªè¡¨ï¼Œå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ä»å¤–éƒ¨è¡¨ä¸­è·å–å„è‡ªéœ€è¦çš„å€¼ã€‚\u003c/p\u003e\n\u003ch2\u003eè„šæœ¬\u003c/h2\u003e\n\u003cp\u003eæ•°æ®æº \u003ccode\u003esubscriptions\u003c/code\u003e è¡¨ä½¿ç”¨ \u003ca href\u003d\"https://github.com/knaufk/flink-faker\"\u003e\u003ccode\u003efaker\u003c/code\u003e connector\u003c/a\u003e æä¾›æ•°æ®ï¼Œå®ƒå¯ä»¥åŸºäº Java Faker è¡¨è¾¾å¼æŒç»­çš„åœ¨å†…å­˜ä¸­ç”Ÿæˆæ•°æ®ã€‚\u003ccode\u003eusers\u003c/code\u003e è¡¨ä½¿ç”¨  \u003ca href\u003d\"https://ci.apache.org/projects/flink/flink-docs-stable/dev/table/connectors/jdbc.html\"\u003eJDBC connector\u003c/a\u003e ä»ä¸€ä¸ªå·²å­˜åœ¨çš„ MYSQL reference è¡¨ä¸­è·å–æ•°æ®ã€‚\u003c/p\u003e\n\n\u003c/div\u003e"
          }
        ]
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1615520569624_169709885",
      "id": "paragraph_1615520569624_169709885",
      "dateCreated": "2021-03-12 03:42:49.625",
      "dateStarted": "2021-03-18 15:57:00.333",
      "dateFinished": "2021-03-18 15:57:00.348",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql\n\nDROP TABLE IF EXISTS subscriptions;\n\nCREATE TABLE subscriptions ( \n    id STRING,\n    user_id INT,\n    type STRING,\n    start_date TIMESTAMP(3),\n    end_date TIMESTAMP(3),\n    payment_expiration TIMESTAMP(3),\n    proc_time AS PROCTIME()\n) WITH (\n  \u0027connector\u0027 \u003d \u0027faker\u0027,\n  \u0027fields.id.expression\u0027 \u003d \u0027#{Internet.uuid}\u0027, \n  \u0027fields.user_id.expression\u0027 \u003d \u0027#{number.numberBetween \u0027\u00271\u0027\u0027,\u0027\u002750\u0027\u0027}\u0027,\n  \u0027fields.type.expression\u0027\u003d \u0027#{regexify \u0027\u0027(basic|premium|platinum){1}\u0027\u0027}\u0027,\n  \u0027fields.start_date.expression\u0027 \u003d \u0027#{date.past \u0027\u002730\u0027\u0027,\u0027\u0027DAYS\u0027\u0027}\u0027,\n  \u0027fields.end_date.expression\u0027 \u003d \u0027#{date.future \u0027\u0027365\u0027\u0027,\u0027\u0027DAYS\u0027\u0027}\u0027,\n  \u0027fields.payment_expiration.expression\u0027 \u003d \u0027#{date.future \u0027\u0027365\u0027\u0027,\u0027\u0027DAYS\u0027\u0027}\u0027\n);\n\nDROP TABLE IF EXISTS users;\n\nCREATE TABLE users (\n user_id INT PRIMARY KEY,\n user_name VARCHAR(255) NOT NULL, \n age INT NOT NULL\n)\nWITH (\n  \u0027connector\u0027 \u003d \u0027jdbc\u0027, \n  \u0027url\u0027 \u003d \u0027jdbc:mysql://localhost:3306/mysql-database\u0027, \n  \u0027table-name\u0027 \u003d \u0027users\u0027, \n  \u0027username\u0027 \u003d \u0027mysql-user\u0027, \n  \u0027password\u0027 \u003d \u0027mysql-password\u0027\n);",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 10:13:13.775",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614305528439_1240137011",
      "id": "paragraph_1614305528439_1240137011",
      "dateCreated": "2021-02-26 10:12:08.439",
      "dateStarted": "2021-02-26 10:13:13.787",
      "dateFinished": "2021-02-26 10:13:14.718",
      "status": "FINISHED"
    },
    {
      "text": "%flink.ssql(type\u003dupdate)\n\nSELECT \n  id AS subscription_id,\n  type AS subscription_type,\n  age AS user_age,\n  CASE \n    WHEN age \u003c 18 THEN 1\n    ELSE 0\n  END AS is_minor\nFROM subscriptions usub\nJOIN users FOR SYSTEM_TIME AS OF usub.proc_time AS u\n  ON usub.user_id \u003d u.user_id;\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 10:13:21.804",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "sql",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12.0,
        "editorMode": "ace/mode/sql",
        "fontSize": 9.0,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614305593778_1681665940",
      "id": "paragraph_1614305593778_1681665940",
      "dateCreated": "2021-02-26 10:13:13.779",
      "dateStarted": "2021-02-26 10:13:21.809",
      "dateFinished": "2021-02-26 10:13:22.703",
      "status": "ERROR"
    },
    {
      "text": "%flink.ssql\n",
      "user": "anonymous",
      "dateUpdated": "2021-02-26 10:13:21.807",
      "progress": 0,
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1614305601807_1982709287",
      "id": "paragraph_1614305601807_1982709287",
      "dateCreated": "2021-02-26 10:13:21.807",
      "status": "READY"
    }
  ],
  "name": "04 Lookup Joins",
  "id": "2FYWYEW8C",
  "defaultInterpreterGroup": "flink",
  "version": "0.10.0-SNAPSHOT",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {},
  "config": {
    "isZeppelinNotebookCronEnable": false
  },
  "info": {}
}